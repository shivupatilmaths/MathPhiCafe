{% extends 'base.html' %}
{% from 'macros.html' import render_field %}
{% block title %}Profile - {{ site_settings.get('site_name', 'MathÏ†Cafe') }}{% endblock %}

{% block content %}
<div style="margin-top:76px;background:var(--light-bg);min-height:calc(100vh - 76px)">
    <div class="container py-4">
        <h3 class="mb-4"><i class="bi bi-person me-2 text-primary"></i>My Profile</h3>

        <div class="row g-4">
            <!-- Profile Info -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm text-center">
                    <div class="card-body p-4">
                        <div class="rounded-circle mx-auto bg-primary-soft d-flex align-items-center justify-content-center mb-3" style="width:100px;height:100px;overflow:hidden">
                            {% if current_user.avatar and current_user.avatar != 'default-avatar.png' %}
                            <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar) }}" alt="" class="w-100 h-100" style="object-fit:cover">
                            {% else %}
                            <i class="bi bi-person display-4 text-primary"></i>
                            {% endif %}
                        </div>
                        <h4 class="mb-1">{{ current_user.full_name }}</h4>
                        <p class="text-primary mb-2">{{ current_user.student_id }}</p>
                        <span class="badge bg-primary">Grade {{ current_user.grade }}</span>

                        <hr class="my-3">
                        <div class="text-start">
                            <p class="small mb-2"><i class="bi bi-envelope me-2 text-muted"></i>{{ current_user.email }}</p>
                            {% if current_user.phone %}
                            <p class="small mb-2"><i class="bi bi-telephone me-2 text-muted"></i>{{ current_user.phone }}</p>
                            {% endif %}
                            {% if current_user.date_of_birth %}
                            <p class="small mb-2"><i class="bi bi-calendar me-2 text-muted"></i>{{ current_user.date_of_birth.strftime('%d %b %Y') }}</p>
                            {% endif %}
                            {% if current_user.parent_name %}
                            <p class="small mb-2"><i class="bi bi-people me-2 text-muted"></i>{{ current_user.parent_name }}</p>
                            {% endif %}
                            {% if current_user.address %}
                            <p class="small mb-0"><i class="bi bi-geo-alt me-2 text-muted"></i>{{ current_user.address }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Forms -->
            <div class="col-lg-8">
                <!-- Update Profile -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent border-0 pt-3">
                        <h5 class="mb-0"><i class="bi bi-pencil me-2 text-primary"></i>Update Profile</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            {{ form.hidden_tag() }}
                            <input type="hidden" name="update_profile" value="1">
                            {{ render_field(form.phone, placeholder='+91 XXXXX XXXXX') }}
                            {{ render_field(form.address, placeholder='Your address') }}
                            {{ render_field(form.avatar) }}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>Update Profile
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Change Password -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 pt-3">
                        <h5 class="mb-0"><i class="bi bi-key me-2 text-primary"></i>Change Password</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            {{ pw_form.hidden_tag() }}
                            <input type="hidden" name="change_password" value="1">
                            {{ render_field(pw_form.current_password, placeholder='Current password') }}
                            <div class="row">
                                <div class="col-md-6">{{ render_field(pw_form.new_password, placeholder='New password (min 6 chars)') }}</div>
                                <div class="col-md-6">{{ render_field(pw_form.confirm_password, placeholder='Confirm new password') }}</div>
                            </div>
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-key me-1"></i>Change Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}